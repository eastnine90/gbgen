name: go-ossf-slsa3-publish

on:
  release:
    # Run only when a release is published (drafts won't trigger this).
    types: [published]

permissions: read-all

jobs:
  args:
    # Extra guard: exclude prereleases even if they are published.
    if: ${{ github.event.release.prerelease == false }}
    runs-on: ubuntu-latest
    outputs:
      commit-date: ${{ steps.meta.outputs.commit-date }}
      commit: ${{ steps.meta.outputs.commit }}
      version: ${{ steps.meta.outputs.version }}
      tree-state: ${{ steps.meta.outputs.tree-state }}
    steps:
      - name: Checkout (tag)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # On release events, build exactly the tagged commit.
          ref: ${{ github.event.release.tag_name }}

      - name: Compute build metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          # Use the release tag as the version (e.g. v0.1.0).
          version="${{ github.event.release.tag_name }}"

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit-date=$(git log --date=iso8601-strict -1 --pretty=%ct)" >> "$GITHUB_OUTPUT"
          echo "tree-state=$(if git diff --quiet; then echo clean; else echo dirty; fi)" >> "$GITHUB_OUTPUT"

  build:
    if: ${{ github.event.release.prerelease == false }}
    permissions:
      id-token: write # To sign provenance.
      contents: write # To upload release assets.
      actions: read   # To read workflow path.
    needs: args
    # Pinned builder version must be full vX.Y.Z per SLSA Go builder docs.
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v2.1.0
    with:
      go-version: 1.24.x
      # Provide evaluated envs for ldflags in .slsa-goreleaser.yml.
      evaluated-envs: >-
        COMMIT_DATE:${{ needs.args.outputs.commit-date }},
        COMMIT:${{ needs.args.outputs.commit }},
        VERSION:${{ needs.args.outputs.version }},
        TREE_STATE:${{ needs.args.outputs.tree-state }}


